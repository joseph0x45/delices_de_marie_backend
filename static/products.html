<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/styles.css">
  <script defer src="/alpine.js"></script>
  <script>
    function get_stored_products() {
      const raw = localStorage.getItem("products")
      return raw ? JSON.parse(raw) : []
    }
    function get_current_order() {
      const raw = localStorage.getItem("current_order")
      if (raw == null) {
        localStorage.setItem("current_order", JSON.stringify({
          client_name: "",
          client_address: "",
          client_phone: "",
          discount: "",
          total: "",
          total_after_discount: "",
        }))
      }
      return JSON.parse(localStorage.getItem("current_order"))
    }

    document.addEventListener('alpine:init', () => {
      let saved = localStorage.getItem("products");
      let current_order = get_current_order()
      let initial = saved ? JSON.parse(saved) : [];

      Alpine.store('products', Alpine.reactive(initial));
      Alpine.store('current_order', Alpine.reactive(current_order))

      Alpine.effect(() => {
        localStorage.setItem("products", JSON.stringify(Alpine.store('products')));
        localStorage.setItem("current_order", JSON.stringify(Alpine.store('current_order')));
      });
    });
  </script>
  <title>Products</title>
</head>

<body class="bg-gray-100">
  <div class="w-full max-w-md md:max-w-xl mx-auto bg-white p-4 rounded shadow mt-8 space-y-4">
    <div class="w-full flex justify-between ">
      <h1>Products</h1>
      <div class="flex gap-4">
        <a title="Add new products" href="/new-product.html">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
        </a>
        <a title="Orders" href="/orders.html">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
          </svg>
        </a>
      </div>
    </div>
    <div x-data="productHandler()" x-init="load_products()">
      <template x-for="product in $store.products" :key="product.id">
        <div x-data="productData()"
          class="my-4 max-w-sm w-full bg-white rounded-2xl shadow-md overflow-hidden border border-gray-200 p-4 flex flex-col justify-between">
          <img :src="product.image" alt="Product Image" class="w-full h-48 object-cover rounded-md" />

          <div class="mt-4">
            <h2 x-text="product.name" class="text-xl font-semibold text-gray-800"></h2>
            <p x-text="product.description" class="text-gray-600 mt-1 text-sm"></p>
            <p x-text="`${product.price} XOF`" class="text-lg font-bold text-indigo-600 mt-2"></p>
          </div>

          <div class="w-full flex justify-between items-center">
            <div class="flex items-center gap-2">
              <button @click="decrease_quantity(product.id)"
                class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300">âˆ’</button>
              <span class="text-lg font-medium w-6 text-center" x-text="product.quantity"></span>
              <button @click="increase_quantity(product.id)"
                class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300">+</button>
            </div>

            <div class="flex items-center">
              <button @click="reset_quantity(product.id)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="size-6">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </template>
    </div>

  </div>
</body>

<script>
  function productHandler() {
    return {
      async load_products() {
        try {
          const response = await fetch("/api/products")
          if (!response.ok) {
            const err = await response.text()
            throw new Error(`Server error: ${err}`)
          }
          const {products} = await response.json()
          const stored_products = get_stored_products()
          const quantity_map = {}
          for (let product of stored_products) {
            quantity_map[product.id] = product.quantity ?? 0
          }
          const merged_products = products.map(p => ({
            ...p,
            quantity: quantity_map[p.id] ?? 0
          }))
          Alpine.store('products', Alpine.reactive(merged_products))
        } catch (error) {
          console.error('Error:', error)
          alert("Failed to load products from API")
        }
      },
    }
  }

  function productData() {
    return {
      quantity: 0,
      reset_quantity(product_id){
        let product = Alpine.store("products").find(p => p.id == product_id)
        if (product) {
          product.quantity = 0
        }
      },
      increase_quantity(product_id) {
        let product = Alpine.store("products").find(p => p.id == product_id)
        if (product) {
          product.quantity++
        }
      },
      decrease_quantity(product_id) {
        let product = Alpine.store("products").find(p => p.id == product_id)
        if (product && product.quantity > 0) {
          product.quantity--
        }
      }
    }
  }
</script>

</html>
